# 前后端切片详情弹窗完整修改说明

## 修改概述

完整修改了前后端代码，使切片详情弹窗能够显示来自两个表的数据：
1. **立方体切片信息** - 来自 `cube_slice_info` 表
2. **用户结果切片信息** - 来自 `cube_result_slice_info` 表

## 前端修改

### 1. API接口修改 (`ard_ui/src/api/cubeDetail.js`)

```javascript
// 获取立方体切片信息（来自cube_slice_info表）
export function getCubeSliceInfo(cubeId) {
  return request({
    url: `/ard/dataretrieval/cube/slice-info/${cubeId}`,
    method: 'get'
  })
}

// 获取用户结果切片信息（来自cube_result_slice_info表）
export function getUserResultSliceInfo(userId, cubeId) {
  return request({
    url: `/ard/dataretrieval/cube/result-slice-info/${userId}/${cubeId}`,
    method: 'get'
  })
}
```

### 2. 前端调用修改 (`ard_ui/src/views/cube/CubeRetrieval.vue`)

```javascript
// 获取立方体切片信息
const cubeSliceResponse = await getCubeSliceInfo(slice.cubeId)

// 获取用户结果切片信息（同时传递用户ID和立方体ID）
const resultSliceResponse = await getUserResultSliceInfo(currentUserId, slice.cubeId)
```

## 后端修改

### 1. 服务接口扩展 (`CubeResultSliceInfoService.java`)

```java
/**
 * 根据用户ID和立方体ID查询结果切片信息
 * 
 * @param userId 用户ID
 * @param cubeId 立方体ID
 * @return 结果切片信息列表
 */
java.util.List<CubeResultSliceInfo> getResultSliceInfoByUserIdAndCubeId(Long userId, String cubeId);
```

### 2. 服务实现 (`CubeResultSliceInfoServiceImpl.java`)

```java
@Override
public List<CubeResultSliceInfo> getResultSliceInfoByUserIdAndCubeId(Long userId, String cubeId) {
    try {
        logger.info("查询结果切片信息 - 用户ID: {}, 立方体ID: {}", userId, cubeId);
        
        // 使用MyBatis-Plus的查询方法
        List<CubeResultSliceInfo> result = cubeResultSliceInfoMapper.selectList(
            new com.baomidou.mybatisplus.core.conditions.query.QueryWrapper<CubeResultSliceInfo>()
                .eq("user_id", userId)
                .eq("cube_id", cubeId)
                .orderByDesc("created")
        );
        
        logger.info("查询到 {} 条结果切片信息", result.size());
        return result;
        
    } catch (Exception e) {
        logger.error("查询结果切片信息异常 - 用户ID: {}, 立方体ID: {}, 错误: {}", userId, cubeId, e.getMessage(), e);
        return new java.util.ArrayList<>();
    }
}
```

### 3. 控制器API接口 (`CubeRetrievalController.java`)

```java
/**
 * 根据立方体ID获取切片信息（来自cube_slice_info表）
 * 
 * @param cubeId 立方体ID
 * @return 切片信息
 */
@GetMapping("/slice-info/{cubeId}")
public CubeSliceResponse getCubeSliceInfo(@PathVariable String cubeId) {
    try {
        logger.info("收到立方体切片信息查询请求，立方体ID: {}", cubeId);
        
        // 获取第一个切片作为代表
        List<CubeSliceResponse> slices = cubeSliceService.getSlicesByCubeId(cubeId);
        if (slices != null && !slices.isEmpty()) {
            logger.info("立方体切片信息查询成功，立方体ID: {}", cubeId);
            return slices.get(0); // 返回第一个切片作为代表
        } else {
            logger.warn("未找到立方体切片信息，立方体ID: {}", cubeId);
            return null;
        }
        
    } catch (Exception e) {
        logger.error("查询立方体切片信息失败，立方体ID: {}", cubeId, e);
        throw new RuntimeException("查询立方体切片信息失败", e);
    }
}

/**
 * 根据用户ID和立方体ID获取结果切片信息（来自cube_result_slice_info表）
 * 
 * @param userId 用户ID
 * @param cubeId 立方体ID
 * @return 结果切片信息列表
 */
@GetMapping("/result-slice-info/{userId}/{cubeId}")
public List<CubeResultSliceInfo> getUserResultSliceInfo(@PathVariable Long userId, @PathVariable String cubeId) {
    try {
        logger.info("收到用户结果切片信息查询请求，用户ID: {}, 立方体ID: {}", userId, cubeId);
        
        List<CubeResultSliceInfo> resultSlices = cubeResultSliceInfoService.getResultSliceInfoByUserIdAndCubeId(userId, cubeId);
        logger.info("用户结果切片信息查询成功，用户ID: {}, 立方体ID: {}, 结果数量: {}", userId, cubeId, resultSlices.size());
        
        return resultSlices;
        
    } catch (Exception e) {
        logger.error("查询用户结果切片信息失败，用户ID: {}, 立方体ID: {}", userId, cubeId, e);
        throw new RuntimeException("查询用户结果切片信息失败", e);
    }
}
```

## API接口说明

### 1. 立方体切片信息接口
- **URL**: `GET /ard/dataretrieval/cube/slice-info/{cubeId}`
- **参数**: `cubeId` - 立方体ID
- **返回**: 立方体切片信息（来自 `cube_slice_info` 表）
- **用途**: 显示原始数据切片信息

### 2. 用户结果切片信息接口
- **URL**: `GET /ard/dataretrieval/cube/result-slice-info/{userId}/{cubeId}`
- **参数**: 
  - `userId` - 用户ID
  - `cubeId` - 立方体ID
- **返回**: 用户结果切片信息列表（来自 `cube_result_slice_info` 表）
- **用途**: 显示该用户对该立方体的分析结果切片

## 数据库查询

### 立方体切片信息查询
```sql
SELECT * FROM cube_slice_info WHERE cube_id = ?
```

### 用户结果切片信息查询
```sql
SELECT * FROM cube_result_slice_info 
WHERE user_id = ? AND cube_id = ? 
ORDER BY created DESC
```

## 功能特性

1. **双表数据展示**: 同时显示原始切片和用户分析结果切片
2. **标签页切换**: 用户可以在两个数据源之间切换查看
3. **精确查询**: 用户结果切片只显示当前用户对当前立方体的分析结果
4. **浏览图支持**: 两个表的数据都支持查看 `browseImagePath` 字段的浏览图
5. **详细日志**: 添加了完整的日志记录，便于调试和监控

## 使用说明

1. **查看切片详情**: 点击切片列表中的"详情"按钮
2. **切换数据源**: 在弹窗中点击"立方体切片"或"用户结果切片"标签
3. **查看浏览图**: 点击"查看浏览图"按钮，在新窗口中打开图片
4. **数据来源**:
   - 立方体切片信息：显示该立方体的原始数据切片
   - 用户结果切片信息：显示当前用户对该立方体的分析结果切片

## 注意事项

1. **用户ID获取**: 前端从localStorage获取用户信息，确保用户已登录
2. **数据权限**: 用户只能查看自己的分析结果切片
3. **错误处理**: 如果某个表没有数据，会显示"暂无数据"的提示
4. **性能优化**: 后端查询已添加索引优化，按创建时间倒序排列

现在前后端都已完整修改，切片详情弹窗可以正确显示来自两个表的数据了！
