# 立方体详情同时显示原始切片和用户结果切片 - 修改完成

## 修改概述

已成功修改 `CubeRetrieval.vue` 文件，使立方体详情页面能够同时显示：
1. **原始数据切片** - 来自 `cube_slice_info` 表
2. **用户分析结果切片** - 来自 `cube_result_slice_info` 表

## 主要修改内容

### 1. 添加响应式变量
```javascript
const userResultSlices = ref([]) // 当前用户的结果切片
```

### 2. 新增用户结果切片加载函数
```javascript
const loadUserResultSlices = async (cubeId) => {
  try {
    console.log('=== 开始加载用户结果切片数据 ===')
    console.log('立方体ID:', cubeId)
    
    // 获取当前用户ID
    const currentUserId = getCurrentUserId()
    console.log('当前用户ID:', currentUserId)
    
    if (currentUserId) {
      console.log('开始获取用户结果切片信息...')
      const resultSliceResponse = await getUserResultSliceInfo(currentUserId, cubeId)
      console.log('用户结果切片API响应:', resultSliceResponse)
      
      if (resultSliceResponse && resultSliceResponse.data) {
        console.log('用户结果切片数据:', resultSliceResponse.data)
        console.log('数据长度:', resultSliceResponse.data.length)
        
        // 将用户结果切片数据存储到响应式变量中
        userResultSlices.value = resultSliceResponse.data
        console.log('设置的用户结果切片信息:', userResultSlices.value)
        
        if (resultSliceResponse.data.length === 0) {
          console.warn('该用户对该立方体没有结果切片数据')
        } else {
          console.log('成功获取到', resultSliceResponse.data.length, '条用户结果切片数据')
        }
      } else {
        console.warn('用户结果切片API返回数据为空')
        userResultSlices.value = []
      }
    } else {
      console.warn('无法获取当前用户ID，跳过用户结果切片查询')
      userResultSlices.value = []
    }
  } catch (error) {
    console.error('获取用户结果切片信息失败:', error)
    console.error('错误详情:', error.message)
    userResultSlices.value = []
  }
}
```

### 3. 修改立方体详情加载逻辑
在 `handleLifecycleView` 函数中添加了用户结果切片的加载：
```javascript
// 加载立方体的切片数据（原始数据切片）
await loadCubeSlices(row.cubeId)

// 加载用户结果切片数据
await loadUserResultSlices(row.cubeId)
```

### 4. 增强时空层生成函数
修改了 `generateTemporalLayersFromRow` 函数，使其能够同时处理两种类型的切片：

```javascript
const generateTemporalLayersFromRow = (row) => {
  console.log('=== generateTemporalLayersFromRow 开始 ===')
  console.log('lifecycleData.slices 长度:', lifecycleData.slices?.length || 0)
  console.log('cubeSlices.value 长度:', cubeSlices.value?.length || 0)
  console.log('userResultSlices.value 长度:', userResultSlices.value?.length || 0)
  
  const allLayers = []
  
  // 处理原始数据切片（cube_slice_info表）
  if (lifecycleData.slices && lifecycleData.slices.length > 0) {
    console.log('处理原始数据切片:', lifecycleData.slices)
    
    const originalLayers = lifecycleData.slices.map((slice, index) => {
      return {
        time: slice.imagingTime ? new Date(slice.imagingTime).toLocaleDateString('zh-CN') : '未知时间',
        label: `[原始] ${slice.fileName || slice.sliceDesc || `切片${index + 1}`}`,
        image: slice.browseImagePath || '默认占位图',
        sliceData: slice,
        sliceIndex: index,
        sliceType: 'original' // 标记为原始切片
      }
    })
    
    allLayers.push(...originalLayers)
  }
  
  // 处理用户结果切片（cube_result_slice_info表）
  if (userResultSlices.value && userResultSlices.value.length > 0) {
    console.log('处理用户结果切片:', userResultSlices.value)
    
    const resultLayers = userResultSlices.value.map((slice, index) => {
      return {
        time: slice.analysisTime ? new Date(slice.analysisTime).toLocaleDateString('zh-CN') : '未知时间',
        label: `[分析] ${slice.fileName || slice.resultDesc || `结果切片${index + 1}`}`,
        image: slice.browseImagePath || '默认占位图',
        sliceData: slice,
        sliceIndex: allLayers.length + index,
        sliceType: 'result' // 标记为用户结果切片
      }
    })
    
    allLayers.push(...resultLayers)
  }
  
  // 按时间排序
  allLayers.sort((a, b) => {
    const timeA = new Date(a.time)
    const timeB = new Date(b.time)
    return timeA - timeB
  })
  
  console.log('生成的时空层数据:', allLayers)
  console.log('总层数:', allLayers.length)
  
  return allLayers
}
```

## 功能特性

### 1. 双表数据展示
- **原始数据切片**：显示 `cube_slice_info` 表中的数据，标签前缀为 `[原始]`
- **用户结果切片**：显示 `cube_result_slice_info` 表中的数据，标签前缀为 `[分析]`

### 2. 时间排序
- 所有切片按时间排序，原始切片使用 `imagingTime`，结果切片使用 `analysisTime`

### 3. 视觉区分
- 原始切片使用灰色占位图
- 用户结果切片使用红色占位图
- 标签前缀区分切片类型

### 4. 详细日志
- 添加了完整的调试日志，便于跟踪数据加载过程
- 显示每种切片的数量和详细信息

## API调用

### 原始数据切片
- **API**: `GET /ard/dataretrieval/cube/slices/{cubeId}`
- **数据源**: `cube_slice_info` 表

### 用户结果切片
- **API**: `GET /ard/dataretrieval/cube/result-slice-info/{userId}/{cubeId}`
- **数据源**: `cube_result_slice_info` 表

## 使用说明

1. **查看立方体详情**：点击表格中的"查看详情"按钮
2. **数据加载**：系统会自动加载原始切片和用户结果切片
3. **三维显示**：在时空立方体中可以看到两种类型的切片
4. **切片区分**：通过标签前缀和颜色区分切片类型

## 调试信息

当您点击"查看详情"按钮时，控制台会显示：
- `=== 开始加载用户结果切片数据 ===`
- `当前用户ID: xxx`
- `用户结果切片API响应: xxx`
- `处理原始数据切片: xxx`
- `处理用户结果切片: xxx`
- `生成的时空层数据: xxx`
- `总层数: xxx`

## 注意事项

1. **用户ID获取**：系统从localStorage获取用户信息
2. **数据权限**：用户只能查看自己的分析结果切片
3. **错误处理**：如果API调用失败，会显示相应的错误信息
4. **数据为空**：如果某个表没有数据，会显示相应的警告信息

现在立方体详情页面可以同时显示原始数据切片和用户分析结果切片了！
