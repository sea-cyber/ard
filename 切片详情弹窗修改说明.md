# 切片详情弹窗修改说明

## 修改概述

修改了 `ard_ui/src/views/cube/CubeRetrieval.vue` 中的检索结果详情弹窗，使其能够显示来自两个表的数据：

1. **立方体切片信息** - 来自 `cube_slice_info` 表
2. **用户结果切片信息** - 来自 `cube_result_slice_info` 表

## 主要修改内容

### 1. API 接口扩展

在 `ard_ui/src/api/cubeDetail.js` 中新增了两个API函数：

```javascript
// 获取立方体切片信息（来自cube_slice_info表）
export function getCubeSliceInfo(cubeId) {
  return request({
    url: `/ard/dataretrieval/cube/slice-info/${cubeId}`,
    method: 'get'
  })
}

// 获取用户结果切片信息（来自cube_result_slice_info表）
export function getUserResultSliceInfo(userId) {
  return request({
    url: `/ard/dataretrieval/cube/result-slice-info/${userId}`,
    method: 'get'
  })
}
```

### 2. 数据结构调整

**原数据结构**：
```javascript
const currentSliceDetail = ref(null) // 单个切片详情
```

**新数据结构**：
```javascript
const sliceDetailData = ref(null) // 包含两个表的数据
const activeTab = ref('cube-slice') // 当前激活的标签页

// 数据结构示例
sliceDetailData.value = {
  cubeSliceInfo: {
    // cube_slice_info表的数据
    sliceId: '',
    cubeId: '',
    quarter: '',
    fileName: '',
    browseImagePath: '', // 浏览图路径
    // ... 其他字段
  },
  resultSliceInfo: [
    // cube_result_slice_info表的数据数组
    {
      cubeId: '',
      userId: '',
      analysisType: '',
      resultSlicePath: '',
      browseImagePath: '', // 浏览图路径
      // ... 其他字段
    }
  ]
}
```

### 3. 弹窗界面重构

**原界面**：单一详情展示
**新界面**：标签页切换展示

```vue
<el-dialog v-model="sliceDetailModalVisible" title="切片详情" width="1000px">
  <el-tabs v-model="activeTab" type="card">
    <!-- 立方体切片信息 -->
    <el-tab-pane label="立方体切片" name="cube-slice">
      <!-- 显示cube_slice_info表的数据 -->
    </el-tab-pane>
    
    <!-- 用户结果切片信息 -->
    <el-tab-pane label="用户结果切片" name="result-slice">
      <!-- 显示cube_result_slice_info表的数据 -->
    </el-tab-pane>
  </el-tabs>
</el-dialog>
```

### 4. 功能方法更新

#### 4.1 查看切片详情方法
```javascript
const handleSliceDetail = async (slice) => {
  // 重置标签页
  activeTab.value = 'cube-slice'
  
  // 初始化详情数据结构
  sliceDetailData.value = {
    cubeSliceInfo: null,
    resultSliceInfo: []
  }
  
  // 获取立方体切片信息
  const cubeSliceResponse = await getCubeSliceInfo(slice.cubeId)
  
  // 获取用户结果切片信息
  const currentUserId = getCurrentUserId()
  const resultSliceResponse = await getUserResultSliceInfo(currentUserId)
  
  // 显示弹窗
  sliceDetailModalVisible.value = true
}
```

#### 4.2 获取当前用户ID
```javascript
const getCurrentUserId = () => {
  const userInfo = localStorage.getItem('userInfo')
  if (userInfo) {
    try {
      const user = JSON.parse(userInfo)
      return user.userId || user.id
    } catch (error) {
      console.warn('解析用户信息失败:', error)
    }
  }
  return null
}
```

#### 4.3 查看浏览图方法
```javascript
// 查看立方体切片浏览图
const viewSliceBrowseImage = async (slice) => {
  // 原有逻辑
}

// 查看结果切片浏览图
const viewResultSliceBrowseImage = async (resultSlice) => {
  if (!resultSlice.browseImagePath) {
    ElMessage.warning('该结果切片暂无浏览图')
    return
  }
  window.open(resultSlice.browseImagePath, '_blank')
}
```

### 5. 样式优化

新增了以下CSS样式：

```css
/* 结果切片项样式 */
.result-slice-item {
  margin-bottom: 20px;
  padding: 16px;
  border: 1px solid #e4e7ed;
  border-radius: 8px;
  background-color: #fafafa;
}

/* 标签页样式优化 */
:deep(.el-tabs__header) {
  margin-bottom: 20px;
}

/* 描述列表样式优化 */
:deep(.el-descriptions__label) {
  font-weight: 500;
  color: #606266;
}
```

## 数据字段说明

### cube_slice_info 表字段
- `sliceId` - 切片ID
- `cubeId` - 立方体ID
- `quarter` - 季度
- `fileName` - 文件名
- `fileFormat` - 文件格式
- `imagingTime` - 成像时间
- `location` - 地理位置
- `resolution` - 分辨率
- `slicePath` - 切片路径
- `sliceDesc` - 描述
- `browseImagePath` - 浏览图路径
- `browseFileName` - 浏览图文件名
- `browseFormat` - 浏览图格式
- `created` - 创建时间
- `updated` - 更新时间
- `createdBy` - 创建人

### cube_result_slice_info 表字段
- `cubeId` - 立方体ID
- `userId` - 用户ID
- `rawSliceId` - 原始切片ID
- `analysisType` - 分析类型
- `resultSlicePath` - 结果切片路径
- `fileName` - 文件名
- `fileFormat` - 文件格式
- `analysisTime` - 分析时间
- `location` - 地理位置
- `resultDesc` - 结果描述
- `resolution` - 分辨率
- `taskId` - 任务ID
- `browseImagePath` - 浏览图路径
- `created` - 创建时间
- `updated` - 更新时间
- `createdBy` - 创建人

## 使用说明

1. **查看切片详情**：点击切片列表中的"详情"按钮
2. **切换标签页**：在弹窗中点击"立方体切片"或"用户结果切片"标签
3. **查看浏览图**：点击"查看浏览图"按钮，会在新窗口中打开图片
4. **数据来源**：
   - 立方体切片信息来自 `cube_slice_info` 表
   - 用户结果切片信息来自 `cube_result_slice_info` 表，只显示当前用户的数据

## 注意事项

1. 需要确保后端API接口 `/ard/dataretrieval/cube/slice-info/{cubeId}` 和 `/ard/dataretrieval/cube/result-slice-info/{userId}` 已实现
2. 用户ID需要从localStorage或用户状态管理中获取
3. 两个表都需要包含 `browseImagePath` 字段用于显示浏览图
4. 如果某个表没有数据，会显示"暂无数据"的提示
