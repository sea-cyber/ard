# 路径修复说明

## 问题分析

您遇到的问题是：
1. 生成的结果还在立方体里面（没有使用用户目录）
2. raw路径没有去掉，但还能查到文件

## 根本原因

代码中硬编码了路径，没有使用配置文件中的路径设置。

## 修复内容

### 1. 原始数据路径修复

**问题**：代码中硬编码了 `D:\GISER\ard\development\cubedata`
**修复**：改为使用配置的路径 `D:\GISER\ard\development\cubedata\ARD_CUB_GRIDT0_OFF_RAW`

```java
// 修复前
String basePath = "D:\\GISER\\ard\\development\\cubedata";

// 修复后  
String basePath = "D:\\GISER\\ard\\development\\cubedata\\ARD_CUB_GRIDT0_OFF_RAW";
```

### 2. 用户数据路径修复

**问题**：UserDataConfig中的路径构建方法参数不匹配
**修复**：更新方法签名，添加quarter参数

```java
// 修复前
public String buildUserAnalysisPath(String username, String gridId, String analysisType)

// 修复后
public String buildUserAnalysisPath(String username, String gridId, String quarter, String analysisType)
```

### 3. 结果存储路径修复

**问题**：结果仍然保存在立方体目录中
**修复**：使用正确的用户目录结构

```java
// 修复前
String resultDirectory = basePath + "\\" + cubeId + "\\result\\" + quarter + "\\" + algorithmCode;

// 修复后
String resultDirectory = userDataConfig.buildUserAnalysisPath(username, cubeId, quarter, algorithmCode);
```

## 最终目录结构

### 原始数据读取路径：
```
D:/GISER/ard/development/cubedata/ARD_CUB_GRIDT0_OFF_RAW/
└── grid_id/
    └── quarter1/
        ├── grid_id_quarter1_B4.TIF
        └── grid_id_quarter1_B5.TIF
```

### 用户分析结果存储路径：
```
D:/GISER/ard/development/userdata/ARD_CUB_GRIDT0_USR/
└── username/
    └── grid_id/
        └── quarter1/
            └── analysis_type/
                └── ndvi_result_xxx.tif
```

## 修复的文件

1. `NDVIWorkflowProcessor.java` - 修复原始数据路径和结果存储路径
2. `UserDataConfig.java` - 更新路径构建方法
3. `WorkflowTaskController.java` - 修复结果保存路径
4. `TaskProcessingServiceImpl.java` - 修复原始数据路径

## 验证方法

1. 检查原始数据是否能正确读取（从 `ARD_CUB_GRIDT0_OFF_RAW/grid_id/quarter` 目录）
2. 检查分析结果是否保存在用户目录中（`ARD_CUB_GRIDT0_USR/username/grid_id/quarter/analysis_type`）
3. 确认不再在立方体目录中生成结果文件

现在代码应该能正确使用您配置的目录结构了。

