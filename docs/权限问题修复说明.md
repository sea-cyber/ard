# 行政区数据访问权限问题修复说明

## 问题描述

非Admin账号登录后访问 `CubeRetrieval.vue` 页面时,省份数据请求被后端拒绝。

## 问题原因

后端控制器 `CountryAdministrativeController` 中的行政区数据查询接口使用了 `@PreAuthorize` 注解进行权限控制,要求用户必须拥有 `dataretrieval:country:query` 权限才能访问。

非Admin用户默认没有此权限,导致请求被拒绝,返回403错误。

## 修复方案

移除行政区数据查询接口的权限限制,因为:
1. 行政区划数据是公开数据
2. 所有登录用户都应该可以访问
3. 不涉及敏感信息

## 修改内容

修改文件: `RuoYi-Vue/ruoyi-admin/src/main/java/com/project/ard/dataretrieval/controller/CountryAdministrativeController.java`

### 移除的权限注解

以下接口移除了 `@PreAuthorize("@ss.hasPermi('dataretrieval:country:query')")` 注解:

1. **查询国家** - `GET /ard/dataretrieval/region/country`
2. **查询省份** - `GET /ard/dataretrieval/region/province`
3. **查询城市** - `GET /ard/dataretrieval/region/city`
4. **查询区县** - `GET /ard/dataretrieval/region/district`
5. **查询几何数据** - `POST /ard/dataretrieval/geometry/byType`
6. **按名称查询** - `GET /ard/dataretrieval/geometry/name`

### 修改示例

修改前:
```java
@ApiOperation("根据regionId查询省(province)")
@PreAuthorize("@ss.hasPermi('dataretrieval:country:query')")
@GetMapping("/region/province")
public AjaxResult getProvinceByRegionId(@ApiParam("regionId") @RequestParam("regionId") String regionId) {
    return success(provinceService.selectByParentRegionId(regionId));
}
```

修改后:
```java
@ApiOperation("根据regionId查询省(province)")
@GetMapping("/region/province")
public AjaxResult getProvinceByRegionId(@ApiParam("regionId") @RequestParam("regionId") String regionId) {
    // 返回该国家下所有省份列表
    return success(provinceService.selectByParentRegionId(regionId));
}
```

## 部署步骤

1. 重新编译后端项目
   ```bash
   cd RuoYi-Vue
   mvn clean package
   ```

2. 重启后端服务
   ```bash
   java -jar ruoyi-admin/target/ruoyi-admin.jar
   ```

3. 清除浏览器缓存并重新登录测试

## 验证方法

1. 使用非Admin账号登录系统
2. 访问立方体检索页面 (`CubeRetrieval.vue`)
3. 选择国家下拉框
4. 确认可以正常加载省份列表
5. 测试省->市->区县的级联选择

## 安全说明

此修改仅移除了行政区数据的权限限制,不影响其他敏感数据的权限控制。所有用户仍需:
- 登录认证后才能访问
- 其他业务数据仍受权限控制
- 数据检索、下载等功能仍需相应权限

## 相关文件

- 后端控制器: `RuoYi-Vue/ruoyi-admin/src/main/java/com/project/ard/dataretrieval/controller/CountryAdministrativeController.java`
- 前端API调用: `RuoYi-Vue3/src/api/cube/data.js`
- 前端页面: `RuoYi-Vue3/src/views/cube/CubeRetrieval.vue`

## 修复日期

2025-01-XX

## 修复人员

AI Assistant








