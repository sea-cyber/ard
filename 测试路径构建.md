# 路径构建测试和验证

## 问题诊断

从日志中看到结果仍保存在旧路径：
```
D:\GISER\ard\development\cubedata\GRID_CUBE_T0_N51E016010\result\2025q1\NDVI_ANALYSIS\ndvi_result_1761292910579.tif
```

应该保存在新路径：
```
D:\GISER\ard\development\userdata\ARD_CUB_GRIDT0_USR\default_user\GRID_CUBE_T0_N51E016010_RAW\2025q1\NDVI_ANALYSIS\ndvi_result_xxx.tif
```

## 解决步骤

### 1. 停止后端服务
请先停止正在运行的后端服务。

### 2. 清理编译缓存
删除以下目录：
- `ard/ruoyi-admin/target/`
- `ard/ruoyi-common/target/`
- `ard/ruoyi-framework/target/`
- `ard/ruoyi-system/target/`

### 3. 重新编译项目
```bash
cd ard
mvn clean compile package -DskipTests
```

### 4. 重新启动后端服务
```bash
cd ard/ruoyi-admin
java -jar target/ruoyi-admin.jar
```

### 5. 验证路径配置

检查 `application.yml` 配置是否正确：
```yaml
ard:
  cube:
    root-path: D:/GISER/ard/development/cubedata/ARD_CUB_GRIDT0_OFF_RAW
  user:
    data-root-path: D:/GISER/ard/development/userdata/ARD_CUB_GRIDT0_USR
```

### 6. 创建用户数据目录
确保用户数据根目录存在：
```bash
mkdir -p D:\GISER\ard\development\userdata\ARD_CUB_GRIDT0_USR\default_user
```

## 关键代码检查点

### UserDataConfig.java
```java
public String buildUserAnalysisPath(String username, String gridId, String quarter, String analysisType) {
    return dataRootPath + "/" + username + "/" + gridId + "/" + quarter + "/" + analysisType;
}
```

应该返回：`D:/GISER/ard/development/userdata/ARD_CUB_GRIDT0_USR/username/grid_id_RAW/quarter/analysis_type`

### NDVIWorkflowProcessor.java - saveNDVIToTiff方法
```java
String resultDirectory = userDataConfig.buildUserAnalysisPath(username, cubeId, quarter, algorithmCode);
```

## 测试方法

1. 在代码中添加日志输出，查看实际构建的路径：
```java
logger.info("=== 路径构建测试 ===");
logger.info("username: {}", username);
logger.info("cubeId: {}", cubeId);
logger.info("quarter: {}", quarter);
logger.info("algorithmCode: {}", algorithmCode);
logger.info("dataRootPath: {}", userDataConfig.getDataRootPath());
logger.info("resultDirectory: {}", resultDirectory);
logger.info("outputPath: {}", outputPath);
```

2. 重新运行任务，检查日志输出

## 预期结果

执行任务后，应该看到：
- 原始数据从 `ARD_CUB_GRIDT0_OFF_RAW/GRID_CUBE_T0_N51E016010/2025q1/` 读取
- 结果保存到 `ARD_CUB_GRIDT0_USR/default_user/GRID_CUBE_T0_N51E016010_RAW/2025q1/NDVI_ANALYSIS/`


